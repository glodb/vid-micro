<!DOCTYPE html>
<html>
<head>
    <title>Profile Update</title>
</head>
<body>
    <h1>Update Profile Information</h1>
    <form id="updateForm">
        <label for="firstName">First Name:</label>
        <input type="text" id="firstName" name="firstName" required><br><br>

        <label for="lastName">Last Name:</label>
        <input type="text" id="lastName" name="lastName" required><br><br>

        <label for="phone">Telephone:</label>
        <input type="text" id="phone" name="phone" required><br><br>

        <label for="email">Email:</label>
        <input type="text" id="email" name="email" disabled required><br><br>

        <button type="button" id="cancelButton">Cancel</button>
        <button type="submit" id="saveButton">Save & Continue</button>
    </form>

    <script>
         window.addEventListener('pageshow', function(event) {
            document.getElementById("email").value = "";
            document.getElementById("firstName").value = "";
            document.getElementById("lastName").value = "";
            document.getElementById("phone").value = "";
            // Check if the event's persisted property is true (page is loaded from cache)
            var email = localStorage.getItem('email')
            var token = localStorage.getItem('token')

            if (!email || email === "" || !token && token === "") {
                window.location.href = '/signup';
            }

            var session = localStorage.getItem('sessionId');
            if (!session || session === "") {
                window.location.href = '/signup';
            }
        });
        document.addEventListener("DOMContentLoaded", async function () {
            const updateForm = document.getElementById("updateForm");
            const cancelButton = document.getElementById("cancelButton");
            const saveButton = document.getElementById("saveButton");

            // Read query parameters
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromQueryParam = urlParams.get("token");
            const emailFromQueryParam = urlParams.get("email");
            const registrationTypeFromQueryParam = urlParams.get("registrationType");

            if (tokenFromQueryParam) {
                localStorage.setItem('token', tokenFromQueryParam);
            }
            if (emailFromQueryParam) {
                localStorage.setItem('email', emailFromQueryParam);
            }

            if (registrationTypeFromQueryParam) {
                localStorage.setItem('registrationType', 2);
            }

            console.log(tokenFromQueryParam, emailFromQueryParam, registrationTypeFromQueryParam)

            // Set email field value
            const tokenFromStorage = localStorage.getItem("token");
            const emailFromStorage = localStorage.getItem("email");


            // Create Basic Authentication header
            const basicAuth = btoa(`${emailFromStorage}:${tokenFromStorage}`);


            // Disable email field if registrationType is not "one"
            const registrationType = localStorage.getItem("registrationType");

            const getUserData = {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Basic ${basicAuth}`,
                        "ssoSession": localStorage.getItem("sessionId")
                    },
                };
            const response = await fetch("/api/getUser", getUserData);
            const data = await response.json();

            
            if (data.code === 1014) {
                const emailField = document.getElementById("email");
                emailField.value = emailFromStorage;

                const firstNameField = document.getElementById("firstName");
                firstNameField.value = data.data.firstName;
                
                const lastNameField = document.getElementById("lastName");
                lastNameField.value = data.data.lastName;

                const phoneField = document.getElementById("phone");
                phoneField.value = data.data.phone;

                console.log(data)
                if (data.data.registrationType === 1) {
                    emailField.disabled = false;
                }


            }

            // Handle form submission
            updateForm.addEventListener("submit", async function (event) {
                event.preventDefault();

                // Read form data
                const firstName = document.getElementById("firstName").value;
                const lastName = document.getElementById("lastName").value;
                const phone = document.getElementById("phone").value;
                const email = document.getElementById("email").value;


                // Prepare request data
                const requestData = {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Basic ${basicAuth}`,
                        "ssoSession": localStorage.getItem("sessionId")
                    },
                    body: JSON.stringify({ firstName, lastName, phone, email })
                };

                // Call API to update user information
                const response = await fetch("/api/updateUser", requestData);
                const data = await response.json();

                // Handle API response
                if (data.code === 1020) {
                    localStorage.setItem("email", email)
                    alert("Profile updated successfully");
                    window.location.href = "/dashboard"; // Redirect to dashboard
                } else {
                    alert(`Error: ${data.message}`);
                }
            });

            // Handle cancel button click
            cancelButton.addEventListener("click", function () {
                window.location.href = "/dashboard"; // Redirect to dashboard
            });
        });
    </script>
</body>
</html>